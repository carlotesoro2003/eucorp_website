import"../chunks/disclose-version.Bg9kRutz.js";import{p as ye,t as L,a as Ne,b as c,g as a,c as _,f as Pe,m as P,s as l,r as n,i as we}from"../chunks/runtime.CLSstnwU.js";import{s as h}from"../chunks/render.D17u6ZCY.js";import{i as M}from"../chunks/if.b2Q-jNLG.js";import{e as Z,i as ee}from"../chunks/each.sV1uapQk.js";import{e as A,a as u,t as x,c as Ee}from"../chunks/utils.kA-YjkFf.js";import{b as ke}from"../chunks/select.BAP3DC-4.js";import{i as $e}from"../chunks/lifecycle.V0dJQ05z.js";import{s as De,a as Se}from"../chunks/store.D2tkwa9F.js";import{o as je}from"../chunks/index-client.DT-fMr9Z.js";import{s as p}from"../chunks/supabaseClient.CaMOPPuz.js";import{E as Fe,a as Te}from"../chunks/jspdf.plugin.autotable.4s0l0uhg.js";import{p as Ue}from"../chunks/stores.DWte6y18.js";var Oe=x("<option> </option>"),Ve=x('<button class="btn btn-secondary mb-4">Export to PDF</button>'),Ie=x("<div>Loading action plans...</div>"),qe=x('<tr><td> </td><td> </td><td> </td><td> </td><td> </td><td class="flex space-x-2"><button class="btn btn-sm btn-success text-white"> </button> <button class="btn btn-sm btn-error text-white">Delete</button></td></tr>'),Re=x('<div class="overflow-x-auto"><table class="table w-full shadow-lg rounded-lg"><thead><tr><th>Department</th><th>Actions Taken</th><th>KPI</th><th>Target Output</th><th>Key Person Responsible</th><th>Actions</th></tr></thead><tbody></tbody></table></div>'),ze=x("<div>No action plans found for this objective.</div>"),Ge=x('<div class="min-h-screen p-8"><h1 class="text-2xl font-bold mb-4">Action Plans</h1> <div class="mb-4 flex gap-4"><select class="select select-bordered"><option>All Departments</option><!></select> <button class="btn btn-primary">All</button> <button class="btn btn-secondary">Approved</button> <button class="btn btn-error">Not Approved</button></div> <!> <!></div>');function tt(te,re){ye(re,!1);const ae=De(),oe=()=>Se(Ue,"$page",ae);let F=[],g=P([]),O=P([]),w=P("all"),E=P("all"),T=null,V=null,I=null,f=P(!1),U=null,k=null,$=null,d=P(null);je(async()=>{const{params:t}=oe();if(I=parseInt(t.id),I)try{await se(),await q(),await ie(),await ne(),await _e(),await le()}catch(r){console.error("Error:",r)}finally{c(f,!1)}else console.error("Objective ID is missing."),c(f,!1)});const se=async()=>{try{const{data:{session:t}}=await p.auth.getSession();if(!t||!t.user)return;const{data:r,error:e}=await p.from("profiles").select("role").eq("id",t.user.id).single();e?console.error("Error fetching user role:",e):c(d,r.role)}catch(t){console.error("Error fetching current user role:",t)}},q=async()=>{const{data:t,error:r}=await p.from("action_plans").select(`
        *,
        profiles (
          first_name,
          last_name,
          departments (name)
        )
      `);r?console.error("Error fetching action plans:",r):(F=t.map(e=>{var s,i,v,b;return{id:e.id,actions_taken:e.actions_taken,kpi:e.kpi,target_output:e.target_output,key_person_responsible:e.key_person_responsible,created_at:e.created_at,objective_id:e.objective_id,is_approved:e.is_approved,is_approved_vp:e.is_approved_vp,is_approved_president:e.is_approved_president,profile_id:e.profile_id,department_name:((i=(s=e.profiles)==null?void 0:s.departments)==null?void 0:i.name)||"Unknown",user_name:`${((v=e.profiles)==null?void 0:v.first_name)||""} ${((b=e.profiles)==null?void 0:b.last_name)||""}`}}),D())},ie=async()=>{const{data:t,error:r}=await p.from("departments").select("id, name");r?console.error("Error fetching departments:",r):c(O,t)},ne=async()=>{const{data:t,error:r}=await p.from("strategic_objectives").select("id, name, strategic_goal_id").eq("id",I).single();if(r)console.error("Error fetching objective:",r);else{T=t;const{data:e,error:s}=await p.from("strategic_goals").select("id, name").eq("id",t.strategic_goal_id).single();s?console.error("Error fetching strategic goal:",s):V=e}},_e=async()=>{try{const{data:t,error:r}=await p.from("profiles").select("first_name, last_name").eq("role","admin");r||!t?(console.error("Error fetching admin names:",r||"No data found"),U="N/A"):U=t.map(e=>`${e.first_name} ${e.last_name}`).join(", ")}catch(t){console.error("Error fetching admin details:",t),U="N/A"}},le=async()=>{try{const{data:t,error:r}=await p.from("profiles").select("first_name, last_name, role").in("role",["vice_president","president"]);if(r||!t){console.error("Error fetching VP and President names:",r||"No data found"),k="N/A",$="N/A";return}const e=t.find(i=>i.role==="vice_president"),s=t.find(i=>i.role==="president");k=e?`${e.first_name} ${e.last_name}`:"N/A",$=s?`${s.first_name} ${s.last_name}`:"N/A"}catch(t){console.error("Error fetching VP and President details:",t),k="N/A",$="N/A"}},D=()=>{let t=[...F];a(d)==="vice_president"&&(t=t.filter(r=>r.is_approved)),a(d)==="president"&&(t=t.filter(r=>r.is_approved&&r.is_approved_vp)),a(w)!=="all"&&(t=t.filter(r=>r.department_name===a(w))),a(E)==="approved"?t=t.filter(r=>r.is_approved):a(E)==="notApproved"&&(t=t.filter(r=>!r.is_approved)),c(g,t)},de=async t=>{const{error:r}=await p.from("action_plans").delete().eq("id",t);r?console.error("Error deleting action plan:",r):await q()},ce=async t=>{let r={};if(c(f,!0),a(d)==="admin")r={is_approved:!0};else if(a(d)==="vice_president")r={is_approved_vp:!0};else if(a(d)==="president")r={is_approved_president:!0};else{c(f,!1);return}try{const{data:e,error:s}=await p.from("action_plans").update(r).eq("id",t).select();if(s){console.error("Error approving action plan:",s);return}if(a(d)==="president"&&e&&e.length>0){const i=e[0],{error:v}=await p.from("plan_monitoring").insert({action_plan_id:i.id,profile_id:i.profile_id,department_id:i.department_id});v&&console.error("Error inserting into plan_monitoring:",v)}await q()}catch(e){console.error("Unexpected error while approving action plan:",e)}finally{c(f,!1)}},pe=()=>{var y,N;const t=((y=F[0])==null?void 0:y.user_name)||"Unknown",r=((N=F[0])==null?void 0:N.department_name)||"Unknown",e=new Fe("landscape");e.setFont("times","normal"),e.setFontSize(12);const s=`${r} Action Plans for Objective: ${(T==null?void 0:T.name)||"N/A"}`,i=V?`Strategic Goal: ${V.name}`:"No Strategic Goal Assigned";e.text("MANUEL S. ENVERGA UNIVERSITY FOUNDATION",14,10),e.text(s,14,15),e.text(i,14,20),e.setFontSize(12),e.text("SY 2024-2025",14,25),e.setFontSize(12);const v=["Actions Taken","KPI","Target Output","Key Person Responsible"],b=a(g).map(m=>[m.actions_taken,m.kpi,m.target_output,m.key_person_responsible]);Te(e,{head:[v],body:b,startY:35,theme:"grid",styles:{fontSize:10},headStyles:{fillColor:[41,128,185]}});const o=e.internal.pageSize.height-30;e.text(`${t} (sgnd)`,14,o-5),e.text("_________________________",14,o),e.text(`${r} Department Head`,14,o+5),e.text(`${U||"N/A"} (sgnd)`,100,o-5),e.text("_________________________",100,o),e.text("Corporate Planning Officer",100,o+5),a(g).some(m=>m.is_approved_vp)?e.text(`${k||"N/A"} (sgnd)`,180,o-5):e.text(`${k||"N/A"}`,180,o-5),e.text("_________________________",180,o),e.text("Vice President",180,o+5),a(g).some(m=>m.is_approved_president)?e.text(`${$||"N/A"} (sgnd)`,260,o-5):e.text(`${$||"N/A"}`,260,o-5),e.text("_________________________",260,o),e.text("President",260,o+5),e.save("ActionPlans.pdf")};$e();var R=Ge(),z=l(_(R),2),S=_(z);L(()=>{a(w),we(()=>{a(O)})});var G=_(S);G.value=(G.__value="all")==null?"":"all";var ve=l(G);Z(ve,1,()=>a(O),ee,(t,r)=>{var e=Oe(),s={},i=_(e,!0);n(e),L(()=>{s!==(s=a(r).name)&&(e.value=(e.__value=a(r).name)==null?"":a(r).name),h(i,a(r).name)}),u(t,e)}),n(S);var B=l(S,2),J=l(B,2),me=l(J,2);n(z);var Q=l(z,2);M(Q,()=>a(g).length>0,t=>{var r=Ve();A("click",r,pe),u(t,r)});var fe=l(Q,2);M(fe,()=>a(f),t=>{var r=Ie();u(t,r)},t=>{var r=Ee(),e=Pe(r);M(e,()=>a(g).length>0,s=>{var i=Re(),v=_(i),b=l(_(v));Z(b,5,()=>a(g),ee,(W,o)=>{var y=qe(),N=_(y),m=_(N,!0);n(N);var K=l(N),ue=_(K,!0);n(K);var Y=l(K),ge=_(Y,!0);n(Y);var C=l(Y),be=_(C,!0);n(C);var H=l(C),he=_(H,!0);n(H);var X=l(H),j=_(X),Ae=_(j,!0);n(j);var xe=l(j,2);n(X),n(y),L(()=>{h(m,a(o).department_name),h(ue,a(o).actions_taken),h(ge,a(o).kpi),h(be,a(o).target_output),h(he,a(o).key_person_responsible),j.disabled=a(f)||a(d)==="admin"&&a(o).is_approved||a(d)==="vice_president"&&(!a(o).is_approved||a(o).is_approved_vp)||a(d)==="president"&&(!a(o).is_approved_vp||a(o).is_approved_president),h(Ae,a(f)?"Processing...":a(d)==="admin"?a(o).is_approved?"Admin Approved":"Approve as Admin":a(d)==="vice_president"?a(o).is_approved_vp?"VP Approved":"Approve as VP":a(d)==="president"?a(o).is_approved_president?"President Approved":"Approve as President":"Approve")}),A("click",j,()=>ce(a(o).id)),A("click",xe,()=>de(a(o).id)),u(W,y)}),n(b),n(v),n(i),u(s,i)},s=>{var i=ze();u(s,i)},!0),u(t,r)}),n(R),ke(S,()=>a(w),t=>c(w,t)),A("change",S,D),A("click",B,()=>{c(E,"all"),D()}),A("click",J,()=>{c(E,"approved"),D()}),A("click",me,()=>{c(E,"notApproved"),D()}),u(te,R),Ne()}export{tt as component};
